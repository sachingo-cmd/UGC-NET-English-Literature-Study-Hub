<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UGC NET English Literature Study Hub</title>
<style>
  :root {
    --color-primary: #6b1a1a;
    --color-secondary: #d9a441;
    --color-bg: #f9f6f1;
    --color-text: #2b2b2b;
    --color-accent: #7a4a1c;
    --shadow: 0 4px 8px rgba(0,0,0,0.1);
    --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; font-family: var(--font-family); background: var(--color-bg); color: var(--color-text);
    min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 1rem;
  }
  h1 { color: var(--color-primary); margin-bottom: 0.25rem; }
  .controls { display: flex; flex-wrap: wrap; gap: 1rem; max-width: 960px; margin-bottom: 1rem; justify-content: center; }
  label { font-weight: 600; margin-right: 0.25rem; }
  select, input[type="number"] { padding: 0.25rem 0.5rem; font-size: 1rem; border: 2px solid var(--color-primary); border-radius: 0.25rem; outline-offset: 2px; }
  button {
    background-color: var(--color-primary); border: none; color: white; padding: 0.5rem 1rem;
    font-weight: 600; border-radius: 0.25rem; cursor: pointer; box-shadow: var(--shadow);
    transition: background-color 0.3s ease;
  }
  button:hover, button:focus { background-color: var(--color-accent); outline: none; }
  button:disabled { background-color: #aaa; cursor: not-allowed; }
  .flashcard-container {
    display: flex; flex-wrap: wrap; gap: 1rem; max-width: 960px; justify-content: center;
  }
  .flip-card {
    background-color: transparent; width: 140px; height: 175px;
    perspective: 1000px; border-radius: 10px;
    transition: height 0.3s ease;
  }
  .flip-card.expanded {
    height: 350px;  /* larger height when expanded */
    min-height: 350px;
  }
  .flip-card-inner {
    position: relative; width: 100%; height: 100%; text-align: center;
    transition: transform 0.8s; transform-style: preserve-3d;
    border-radius: 10px; box-shadow: var(--shadow); cursor: pointer;
  }
  .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
  .flip-card-front, .flip-card-back {
    position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden;
    backface-visibility: hidden; border-radius: 10px; display: flex; flex-direction: column;
    justify-content: center; align-items: center; padding: 0.5rem; overflow: hidden;
  }
  .flip-card-front {
    background-color: white; overflow: hidden;
  }
  .flip-card-back {
    background-color: var(--color-secondary);
    color: var(--color-bg);
    transform: rotateY(180deg);
    overflow-y: auto; /* important for scrolling works content */
    padding-right: 0.5rem; /* scrollbar space */
    box-sizing: border-box; /* include padding */
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }
  .flip-card-back ul {
    width: 100%;
    padding-left: 1rem;
    margin-top: 0.5rem;
    list-style: square;
    font-size: 0.9rem; 
    overflow-wrap: break-word;
    white-space: normal;
    word-break: break-word;
  }
  .flip-card-back ul li { margin-bottom: 0.15rem; }
  .author-image {
    max-width: 90%; max-height: 90%; border-radius: 8px; object-fit: contain; box-shadow: var(--shadow);
    pointer-events: none;
  }
  .works-list-front .flip-card-front {
    background-color: var(--color-secondary); color: var(--color-bg); overflow-y: auto;
    text-align: left; font-size: 0.9rem;
  }
  .works-list-front .flip-card-front ul {
    margin: 0; padding-left: 0.5rem; list-style: square;
  }
  .works-list-front .flip-card-front ul li { margin-bottom: 0.15rem; }
  .works-list-front .flip-card-back {
    background-color: white; color: var(--color-text); flex-direction: column;
    justify-content: center; align-items: center; font-size: 0.75rem;
  }
  .works-list-front .flip-card-back .author-name { margin-top: 0.25rem; font-weight: 700; }
  .flash-info-section {
    background: white; max-width: 960px; width: 100%;
    margin-top: 0; margin-bottom: 1rem; padding: 1rem; border-radius: 10px;
    box-shadow: var(--shadow);
  }
  .flash-info-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;
  }
  .flash-info-content {
    max-height: 250px; overflow-y: auto; padding: 0.5rem; border: 2px solid var(--color-primary);
    border-radius: 8px; background: var(--color-bg); font-size: 1rem; line-height: 1.4; white-space: pre-wrap;
  }
  .flash-info-keyword {
    font-weight: 700; margin-bottom: 0.5rem; font-size: 1.1rem; color: var(--color-primary);
  }
  .flash-info-author-img {
    max-width: 80px; max-height: 80px; border-radius: 8px; float: left; margin-right: 10px;
  }
  .stats {
    font-size: 0.9rem; margin-top: 0.5rem; text-align: center; color: var(--color-primary);
  }
  @media (max-width: 768px) {
    .flip-card { width: 90vw; height: 175px; }
    .flip-card.expanded { height: 350px; }
    .controls { flex-direction: column; gap: 0.5rem; }
    .flash-info-content { max-height: 200px; }
  }
</style>
</head>
<body>
<h1>UGC NET English Literature Study Hub</h1>
<div class="controls" aria-label="Study Filters and Controls">
  <div><label for="module-select">Module:</label>
    <select id="module-select" aria-label="Select Module"><option value="">--Select Module--</option></select>
  </div>
  <div><label for="chapter-select">Chapter:</label>
    <select id="chapter-select" disabled aria-label="Select Chapter"><option value="">--Select Chapter--</option></select>
  </div>
  <div><label for="work-type-select">Work Type:</label>
    <select id="work-type-select" aria-label="Filter by Work Type">
      <option value="all">All</option>
      <option value="Drama">Drama</option>
      <option value="Poetry">Poetry</option>
      <option value="Essay">Essay</option>
      <option value="Play">Play</option>
      <option value="Novel">Novel</option>
      <option value="Epic Poem">Epic Poem</option>
      <option value="Releigious Epic">Releigious Epic</option>
      <option value="Elegy">Elegy</option>
      <option value="Religious Poem">Religious Poem</option>
      <option value="Debate Poem">Debate Poem</option>
      <option value="Visionary Poem">Visionary Poem</option>
      <option value="Hymn">Hymn</option>
    </select>
  </div>
  <div><label for="year-start">Year Start:</label>
    <input type="number" id="year-start" placeholder="e.g. 1800" min="1000" max="2100" aria-label="Start Year" />
  </div>
  <div><label for="year-end">Year End:</label>
    <input type="number" id="year-end" placeholder="e.g. 2000" min="1000" max="2100" aria-label="End Year" />
  </div>
  <div>
    <button id="apply-filter-btn" title="Apply filters">Apply Filters</button>
    <button id="clear-filter-btn" title="Clear all filters">Clear Filters</button>
    <button id="rescan-btn" title="Reload data from CSV">Rescan Data</button>
  </div>
  <div>
    <label for="mode-select">Flashcard Mode:</label>
    <select id="mode-select" aria-label="Select Flashcard Display Mode">
      <option value="authorfront">Author Image Front</option>
      <option value="worksfront">Works Front</option>
    </select>
  </div>
  <div>
    <button id="toggle-flashcards-btn" aria-pressed="true">Hide Flashcards</button>
  </div>
</div>

<section class="flash-info-section" aria-label="Flash Info Section">
  <div class="flash-info-header">
    <h2>Flash Info Game</h2>
    <button id="random-flash-info-btn" disabled>Show Random Flash Info</button>
  </div>
  <div class="flash-info-content" id="flash-info-content" tabindex="0">
    <p>Load and select module/chapter to start.</p>
  </div>
</section>

<div class="stats" role="region" aria-live="polite" id="stats-info">
  Authors Loaded: 0 | Works Loaded: 0 | Flash Infos Loaded: 0
</div>

<div class="flashcard-container" id="flashcard-container" aria-label="Flashcards Section">
  <!-- Flashcards will be injected here -->
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
(function() {
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQolLlUE8ZSI3AQBWAjjsrhrAK6PdCsjviT94joVNZxZUpyre2vZXqzJFMGgnazCoGPvUICvcSnd0Sj/pub?output=csv";
  const AUTHOR_CACHE_KEY = "authorFlashcardsCache";
  let authors = [], flashInfos = [], filteredAuthors = [], filteredFlashInfos = [], currentFlashInfoIndicesShown = new Set();
  const moduleSelect = document.getElementById('module-select');
  const chapterSelect = document.getElementById('chapter-select');
  const workTypeSelect = document.getElementById('work-type-select');
  const yearStartInput = document.getElementById('year-start');
  const yearEndInput = document.getElementById('year-end');
  const applyFilterBtn = document.getElementById('apply-filter-btn');
  const clearFilterBtn = document.getElementById('clear-filter-btn');
  const rescanBtn = document.getElementById('rescan-btn');
  const modeSelect = document.getElementById('mode-select');
  const toggleFlashcardsBtn = document.getElementById('toggle-flashcards-btn');
  const statsInfo = document.getElementById('stats-info');
  const flashcardContainer = document.getElementById('flashcard-container');
  const randomFlashInfoBtn = document.getElementById('random-flash-info-btn');
  const flashInfoContent = document.getElementById('flash-info-content');

  function parseWorks(worksString) {
    if (!worksString) return [];
    return worksString.split(';').map(work => {
      const trimmed = work.trim();
      const detailMatch = trimmed.match(/\{([^}]*)\}/);
      const yearMatch = trimmed.match(/\(([^)]+)\)/);
      const typeMatch = trimmed.match(/\[(.*?)\]/);
      let title = trimmed.replace(/\{[^}]*\}/g, '').replace(/\([^)]*\)/g, '').replace(/\[.*?\]/g, '').trim();
      const year = yearMatch ? yearMatch[1] : '';
      const type = typeMatch ? typeMatch[1].trim() : '';
      const detail = detailMatch ? detailMatch[1].trim() : '';
      return { title, year, type, detail };
    });
  }

  function loadCSVWithCache(url, cacheKey, forceReload = false) {
    return new Promise(resolve => {
      if (!forceReload) {
        const cachedData = localStorage.getItem(cacheKey);
        if (cachedData) {
          try {
            const parsed = JSON.parse(cachedData);
            resolve(parsed);
            return;
          } catch(e) {
            console.error('Cache parse error', e);
          }
        }
      } else {
        localStorage.removeItem(cacheKey);
      }

      Papa.parse(url, {
        download: true,
        header: true,
        complete: results => {
          localStorage.setItem(cacheKey, JSON.stringify(results.data));
          resolve(results.data);
        },
        error: (err) => {
          console.error('PapaParse error:', err);
          resolve([]);
        }
      });
    });
  }

  function uniqueValues(data, field) {
    return [...new Set(data.map(item => item[field]).filter(x => x && x.length > 0))].sort();
  }

  function clearSelectOptions(selectElem) {
    selectElem.innerHTML = '';
  }
  function fillSelectOptions(selectElem, options, placeholder = '--Select--') {
    clearSelectOptions(selectElem);
    const placeholderOption = document.createElement('option');
    placeholderOption.textContent = placeholder;
    placeholderOption.value = '';
    selectElem.appendChild(placeholderOption);
    options.forEach(opt => {
      const optionElem = document.createElement('option');
      optionElem.value = opt;
      optionElem.textContent = opt;
      selectElem.appendChild(optionElem);
    });
  }

  function filterAuthors() {
    let filtered = authors;
    const selectedModule = moduleSelect.value;
    const selectedChapter = chapterSelect.value;
    const workType = workTypeSelect.value;
    const yearStart = parseInt(yearStartInput.value, 10);
    const yearEnd = parseInt(yearEndInput.value, 10);

    if(selectedModule) {
      filtered = filtered.filter(author => author.Module === selectedModule && (!selectedChapter || author.Chapter === selectedChapter));
    }
    else {
      filtered = [];
    }
    if (workType !== 'all') {
      filtered = filtered.filter(author => author.works.some(w => w.type.toLowerCase() === workType.toLowerCase()));
    }
    if (!isNaN(yearStart) || !isNaN(yearEnd)) {
      filtered = filtered.filter(author => author.works.some(w => {
        const y = parseInt(w.year, 10);
        if (!y) return false;
        if (!isNaN(yearStart) && y < yearStart) return false;
        if (!isNaN(yearEnd) && y > yearEnd) return false;
        return true;
      }));
    }
    filteredAuthors = filtered;
  }

  function buildFlashInfoFromAuthors() {
    const combined = [];
    // Add author flash info entries (title = author name)
    flashInfos.forEach(item => {
      if(item.FlashInfoText && item.FlashInfoText.trim() !== '') {
        combined.push({
          Module: item.Module,
          Chapter: item.Chapter,
          Title: item.AuthorName,
          ImageURL: item.ImageURL || '',
          FlashInfoText: item.FlashInfoText,
          Type: 'author'
        });
      }
    });
    // Add works with details flash info entries
    authors.forEach(author => {
      author.works.forEach(work => {
        if(work.detail && work.detail.length > 0) {
          combined.push({
            Module: author.Module,
            Chapter: author.Chapter,
            Title: work.title,
            ImageURL: author.ImageURL,
            FlashInfoText: work.detail,
            Type: 'work',
            AuthorName: author.AuthorName
          });
        }
      });
    });
    // Add keyword flash info entries parsed from ImportantKeywords column
    authors.forEach(author => {
      const row = flashInfos.find(i => i.Module === author.Module && i.Chapter === author.Chapter && i.AuthorName === author.AuthorName);
      if(row && row.ImportantKeywords){
        const kws = row.ImportantKeywords.split(';').map(k=>k.trim()).filter(k => k.length>0);
        kws.forEach(k=>{
          const match = k.match(/^(.+?)(?:\s*\{(.*)\})?$/);
          if(match){
            const kwTitle = match[1].trim();
            const kwDetail = match[2]?match[2].trim():'';
            combined.push({
              Module: author.Module,
              Chapter: author.Chapter,
              Title: kwTitle,
              FlashInfoText: kwDetail,
              Type: 'keyword'
            });
          }
        });
      }
    });
    return combined;
  }

  function renderFlashcards() {
    flashcardContainer.innerHTML = '';
    if (filteredAuthors.length === 0) {
      flashcardContainer.innerHTML = '<p>No authors found with the applied filters.</p>';
      return;
    }
    filteredAuthors.forEach(author => {
      const card = document.createElement('div');
      card.classList.add('flip-card');
      if (modeSelect.value === 'worksfront') card.classList.add('works-list-front');
      const inner = document.createElement('div');
      inner.classList.add('flip-card-inner');
      const front = document.createElement('div');
      front.classList.add('flip-card-front');
      const back = document.createElement('div');
      back.classList.add('flip-card-back');
      if (modeSelect.value === 'authorfront') {
        const img = document.createElement('img');
        img.src = author.ImageURL;
        img.alt = `Image of ${author.AuthorName}`;
        img.className = 'author-image';
        front.appendChild(img);
        const name = document.createElement('h3');
        name.textContent = `${author.AuthorName} (${author.BirthYear || 'N/A'})`;
        back.appendChild(name);
        const ul = document.createElement('ul');
        author.works.forEach(w => {
          const li = document.createElement('li');
          li.textContent = `${w.title} ${w.year ? '('+w.year+')' : ''} ${w.type ? '['+w.type+']' : ''}`;
          ul.appendChild(li);
        });
        back.appendChild(ul);
      } else {
        const ul = document.createElement('ul');
        author.works.forEach(w => {
          const li = document.createElement('li');
          li.textContent = `${w.title} ${w.year ? '('+w.year+')' : ''} ${w.type ? '['+w.type+']' : ''}`;
          ul.appendChild(li);
        });
        front.appendChild(ul);
        const img = document.createElement('img');
        img.src = author.ImageURL;
        img.alt = `Image of ${author.AuthorName}`;
        img.className = 'author-image';
        back.appendChild(img);
        const name = document.createElement('h3');
        name.textContent = `${author.AuthorName} (${author.BirthYear || 'N/A'})`;
        back.appendChild(name);
      }
      inner.appendChild(front);
      inner.appendChild(back);
      card.appendChild(inner);

      card.addEventListener('click', () => {
        // Unflip other cards and collapse
        document.querySelectorAll('.flip-card.flipped').forEach(el => {
          if(el !== card){
            el.classList.remove('flipped');
            el.classList.remove('expanded');
          }
        });
        card.classList.toggle('flipped');
        card.classList.toggle('expanded');
      });

      flashcardContainer.appendChild(card);
    });
    updateStats();
  }

  function filterFlashInfos() {
    const selectedModule = moduleSelect.value;
    const selectedChapter = chapterSelect.value;
    if(selectedModule && selectedChapter){
      filteredFlashInfos = buildFlashInfoFromAuthors().filter(i => i.Module === selectedModule && i.Chapter === selectedChapter);
    } else {
      filteredFlashInfos = [];
    }
    currentFlashInfoIndicesShown = new Set();
    randomFlashInfoBtn.disabled = filteredFlashInfos.length === 0;
  }

  function escapeHTML(text){
    return text ? text.replace(/[&<>"']/g, function(m) {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    }) : '';
  }

  function showRandomFlashInfo(){
    if(filteredFlashInfos.length === 0){
      flashInfoContent.innerHTML = '<p>No flash info available for selected module and chapter.</p>';
      return;
    }
    if(currentFlashInfoIndicesShown.size >= filteredFlashInfos.length) currentFlashInfoIndicesShown.clear();
    let idx;
    do {
      idx = Math.floor(Math.random() * filteredFlashInfos.length);
    } while(currentFlashInfoIndicesShown.has(idx) && currentFlashInfoIndicesShown.size < filteredFlashInfos.length);
    currentFlashInfoIndicesShown.add(idx);
    const item = filteredFlashInfos[idx];
    let html = '';
    if(item.Type === 'author' || item.Type === 'work'){
      if(item.ImageURL) html += `<img src="${item.ImageURL}" alt="Image of ${escapeHTML(item.AuthorName || item.Title || '')}" class="flash-info-author-img" />`;
    }
    html += `<div class="flash-info-keyword">${escapeHTML(item.Title || '')}</div>`;
    html += `<p>${escapeHTML(item.FlashInfoText || '')}</p>`;
    flashInfoContent.innerHTML = html;
  }

  function updateStats(){
    const totalAuthors = authors.length;
    let totalWorks = 0; authors.forEach(a => { totalWorks += a.works.length; });
    const totalFlashInfos = flashInfos.length;
    statsInfo.textContent = `Authors Loaded: ${totalAuthors} | Works Loaded: ${totalWorks} | Flash Infos Loaded: ${totalFlashInfos}`;
  }

  function resetFilters(){
    moduleSelect.value = '';
    chapterSelect.value = '';
    chapterSelect.disabled = true;
    workTypeSelect.value = 'all';
    yearStartInput.value = '';
    yearEndInput.value = '';
    filteredAuthors = [];
    filteredFlashInfos = [];
    currentFlashInfoIndicesShown.clear();
    flashcardContainer.innerHTML = '';
    flashInfoContent.innerHTML = '<p>Load and select module/chapter to start.</p>';
    randomFlashInfoBtn.disabled = true;
  }

  function populateChapters(){
    const selectedModule = moduleSelect.value;
    if(!selectedModule){
      chapterSelect.innerHTML = '<option value="">--Select Chapter--</option>';
      chapterSelect.disabled = true;
      return;
    }
    const chapters = uniqueValues(flashInfos.filter(f => f.Module === selectedModule), 'Chapter');
    fillSelectOptions(chapterSelect, chapters, '--Select Chapter--');
    chapterSelect.disabled = false;
  }

  async function loadAndPrepareData(forceReload = false){
    const rawData = await loadCSVWithCache(CSV_URL, AUTHOR_CACHE_KEY, forceReload);
    authors = processAuthorData(rawData);
    flashInfos = processFlashInfoData(rawData);
    filteredAuthors = [];
    filteredFlashInfos = [];
    currentFlashInfoIndicesShown.clear();

    const modulesFromFlashInfo = uniqueValues(flashInfos, 'Module');
    const modulesFromAuthors = uniqueValues(authors, 'Module');
    const combinedModules = [...new Set([...modulesFromFlashInfo, ...modulesFromAuthors])].sort();
    fillSelectOptions(moduleSelect, combinedModules, '--Select Module--');

    resetFilters();
    updateStats();
  }

  moduleSelect.addEventListener('change', () => {
    populateChapters();
    filteredAuthors = [];
    currentFlashInfoIndicesShown.clear();
    flashcardContainer.innerHTML = '';
    flashInfoContent.innerHTML = '<p>Load and select module/chapter to start.</p>';
    applyFilters();
  });

  chapterSelect.addEventListener('change', () => {
    applyFilters();
  });

  workTypeSelect.addEventListener('change', () => {
    applyFilters();
  });

  applyFilterBtn.addEventListener('click', () => {
    applyFilters();
  });

  clearFilterBtn.addEventListener('click', () => {
    resetFilters();
  });

  rescanBtn.addEventListener('click', () => {
    loadAndPrepareData(true);
  });

  modeSelect.addEventListener('change', () => {
    renderFlashcards();
  });

  randomFlashInfoBtn.addEventListener('click', () => {
    showRandomFlashInfo();
  });

  toggleFlashcardsBtn.addEventListener('click', () => {
    const isVisible = flashcardContainer.style.display !== 'none';
    if(isVisible){
      flashcardContainer.style.display = 'none';
      toggleFlashcardsBtn.textContent = 'Show Flashcards';
      toggleFlashcardsBtn.setAttribute('aria-pressed', 'false');
    } else{
      flashcardContainer.style.display = 'flex';
      toggleFlashcardsBtn.textContent = 'Hide Flashcards';
      toggleFlashcardsBtn.setAttribute('aria-pressed', 'true');
    }
  });

  function applyFilters(){
    filterAuthors();
    renderFlashcards();
    filterFlashInfos();
  }

  function processAuthorData(rows){
    return rows.map(row => ({
      ID: row.ID || '',
      ImageURL: row.ImageURL || '',
      AuthorName: row.AuthorName || '',
      BirthYear: row.BirthYear || '',
      Module: row.Module || '',
      Chapter: row.Chapter || '',
      works: parseWorks(row.Works)
    })).filter(a => a.AuthorName);
  }

  function processFlashInfoData(rows){
    return rows.map(row => ({
      Module: row.Module || '',
      Chapter: row.Chapter || '',
      AuthorName: row.AuthorName || '',
      Works: row.Works || '',
      ImportantKeywords: row.ImportantKeywords || '',
      ImageURL: row.ImageURL || '',
      FlashInfoText: row.FlashInfoText || ''
    })).filter(f => f.Module && f.Chapter);
  }

  loadAndPrepareData();
})();
</script>
</body>
</html>
